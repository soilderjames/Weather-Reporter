/*
 * IL9341.c
 *
 *  Created on: Oct 9, 2021
 *      Author: YIFAN
 */

#include "IL9341.h"
void CMDWRITE(uint8_t cmd) {
	DC0;
	CS0;
	HAL_SPI_Transmit_DMA(&hspi1, &cmd, sizeof(cmd));
	CS1;
}
void DATAWRITE(uint8_t data) {
	DC1;
	CS0;
	HAL_SPI_Transmit_DMA(&hspi1, &data, sizeof(data));
	CS1;
}

void DATA16WRITE(uint16_t DATA) {
	DC1;
	CS0;
	uint8_t data[2];
	data[0] = DATA >> 8;
	data[1] = DATA;
	HAL_SPI_Transmit_DMA(&hspi1, data, sizeof(data));
	CS1;
}
void DMAWRITE(uint8_t *data, uint16_t size) {
	DC1;
	CS0;
	HAL_SPI_Transmit_DMA(&hspi1, data, size);
	while (HAL_SPI_STATE_BUSY_TX == HAL_SPI_GetState(&hspi1))
		; //等待DMA传输结束，必须！！！
	CS1;
}

void LCDINIT(void) {
	RES1;
	HAL_Delay(10);
	RES0;
	HAL_Delay(10);
	RES1;
	HAL_Delay(10);
	CMDWRITE(0x01);
	HAL_Delay(100);
	//POWER CONTROL A
	CMDWRITE(0xCB);
	DATAWRITE(0x39);
	DATAWRITE(0x2C);
	DATAWRITE(0x00);
	DATAWRITE(0x34);
	DATAWRITE(0x02);

	//POWER CONTROL B
	CMDWRITE(0xCF);
	DATAWRITE(0x00);
	DATAWRITE(0xC1);
	DATAWRITE(0x30);

	//DRIVER TIMING CONTROL A
	CMDWRITE(0xE8);
	DATAWRITE(0x85);
	DATAWRITE(0x00);
	DATAWRITE(0x78);

	//DRIVER TIMING CONTROL B
	CMDWRITE(0xEA);
	DATAWRITE(0x00);
	DATAWRITE(0x00);

	//POWER ON SEQUENCE CONTROL
	CMDWRITE(0xED);
	DATAWRITE(0x64);
	DATAWRITE(0x03);
	DATAWRITE(0x12);
	DATAWRITE(0x81);

	//PUMP RATIO CONTROL
	CMDWRITE(0xF7);
	DATAWRITE(0x20);

	//POWER CONTROL,VRH[5:0]
	CMDWRITE(0xC0);
	DATAWRITE(0x23);

	//POWER CONTROL,SAP[2:0];BT[3:0]
	CMDWRITE(0xC1);
	DATAWRITE(0x10);

	//VCM CONTROL
	CMDWRITE(0xC5);
	DATAWRITE(0x3E);
	DATAWRITE(0x28);

	//VCM CONTROL 2
	CMDWRITE(0xC7);
	DATAWRITE(0x86);

	//MEMORY ACCESS CONTROL
	CMDWRITE(0x36);
	DATAWRITE(0x88);

	//PIXEL FORMAT
	CMDWRITE(0x3A);
	DATAWRITE(0x55);

	//FRAME RATIO CONTROL, STANDARD RGB COLOR
	CMDWRITE(0xB1);
	DATAWRITE(0x00);
	DATAWRITE(0x18);

	//DISPLAY FUNCTION CONTROL
	CMDWRITE(0xB6);
	DATAWRITE(0x08);
	DATAWRITE(0x82);
	DATAWRITE(0x27);

	//3GAMMA FUNCTION DISABLE
	CMDWRITE(0xF2);
	DATAWRITE(0x00);

	//GAMMA CURVE SELECTED
	CMDWRITE(0x26);
	DATAWRITE(0x01);

	//POSITIVE GAMMA CORRECTION
	CMDWRITE(0xE0);
	DATAWRITE(0x0F);
	DATAWRITE(0x31);
	DATAWRITE(0x2B);
	DATAWRITE(0x0C);
	DATAWRITE(0x0E);
	DATAWRITE(0x08);
	DATAWRITE(0x4E);
	DATAWRITE(0xF1);
	DATAWRITE(0x37);
	DATAWRITE(0x07);
	DATAWRITE(0x10);
	DATAWRITE(0x03);
	DATAWRITE(0x0E);
	DATAWRITE(0x09);
	DATAWRITE(0x00);

	//NEGATIVE GAMMA CORRECTION
	CMDWRITE(0xE1);
	DATAWRITE(0x00);
	DATAWRITE(0x0E);
	DATAWRITE(0x14);
	DATAWRITE(0x03);
	DATAWRITE(0x11);
	DATAWRITE(0x07);
	DATAWRITE(0x31);
	DATAWRITE(0xC1);
	DATAWRITE(0x48);
	DATAWRITE(0x08);
	DATAWRITE(0x0F);
	DATAWRITE(0x0C);
	DATAWRITE(0x31);
	DATAWRITE(0x36);
	DATAWRITE(0x0F);
	CMDWRITE(0x11);    //Exit Sleep
	CMDWRITE(0x29);    //Display on
}

void ADRSET(uint16_t x1, uint16_t y1, uint16_t x2, uint16_t y2) {
	CMDWRITE(0x2a);
	DATAWRITE(x1 >> 8);
	DATAWRITE(x1);
	DATAWRITE(x2 >> 8);
	DATAWRITE(x2);
	CMDWRITE(0x2b);
	DATAWRITE(y1 >> 8);
	DATAWRITE(y1);
	DATAWRITE(y2 >> 8);
	DATAWRITE(y2);
	CMDWRITE(0x2c);
}

void LCDFILL(uint16_t color) {
	int i = 0;
	ADRSET(0, 0, 239, 319);
	for (i = 0; i <= 76800; i++) {
		DATA16WRITE(color);
	}

}

